<!DOCTYPE html>
<html>

<head>
	<meta charset = 'utf-8'>
	<title>Chukchansi-English Speaking Dictionary</title>
	<link rel='stylesheet' href='style/mobile.css'>
</head>

<body>

	<div id='navBar'>
		Chukchansi Dictionary
	</div>
	<div class='flex-row searchBoxTemp'>
		<div class='flex-button'></div>
		<div class='flex-button'></div>
		<div class='flex-button'></div>
	</div>
	<div id='searchResults' class='noScrollbar'>
		<!-- <div class='loadingSpinner'></div> -->
		<div class='loading'>
			<div class='loading-diamond loading-left'></div>
			<div class='loading-diamond loading-right'></div>
		</div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
		<div class='dummyResult'></div>
	</div>



	<!-- <div id='searchPanel' class='noScrollbar'>
		<div class='searchResult'>Result 0</div>
		<div class='searchResult'>Result 1</div>
		<div class='searchResult'>Result 2</div>
		<div class='searchResult'>Result 3</div>
		<div class='searchResult'>Result 4</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
		<div class='searchResult'>Result N</div>
	</div> -->
	<!-- <div id='searchBox'>
		<input id='searchBar' type='text' placeholder='Search...'>
			<div class='searchButton'></div>
			<div class='searchButton'></div>
			<div class='searchButton'></div> -->
		<!-- <div id='searchSubmitButton' class='searchButton'>
		</div>
		<div id='searchClearButton' class='searchButton'>
			<div class="searchClearCross" style="transform: translate(-50%, -50%) rotate(45deg)"></div>
			<div class="searchClearCross" style="transform: translate(-50%, -50%) rotate(-45deg)"></div>
		</div>
		<div id='searchHistoryButton' class='searchButton'>
			<div id="searchHistoryArrow" class="arrowDown"></div>
		</div> -->
		
	<!-- </div> -->
	<!-- <div id='contentPanel'></div> -->

	<!-- create loading screen -->

	<!-- load dependencies -->
	<script type='text/javascript' src='script/dictionary.js'></script>
	<script type='text/javascript' src='data/en-ch-v10.js'></script>
	<script type='text/javascript' src='source/resources.js'></script>

	<script>
		
		//// WAVE 3 ////

		// 1.0 hrs: design/style left panel (search)
		// 0.5 hrs: add media queries for responsive styling
		// 1.0 hrs: fully integrate responsive styling for navbar and search panel
		// 0.5 hrs: partial flexbox impl
		// 1.0 hrs: fix panelling, add panel animations
		// 1.5 hrs: re-integrate search, begin updating to flexbox
		// 0.5 hrs: re-integrate search results (non-interactive)
		// 1.0 hrs: diagnose mobile visual glitches and panelling issues
		// 0.5 hrs: optimize loading sequence for mobile
		// 1.5 hrs: add mobile-focused loading screen w/ dummy elements
		// 0.5 hrs: new loading screen animation, load order optimization
		// 1.0 hrs: research web workers for multithreading and responsiveness
		// 2.5 hrs: add media resource indexing to reduce load/search time, dynamic DOM construction optimization

		/////////////////////////////////////////////////////////////////////

		//// ENV SETUP ////

		// debug
		let t0 = performance.now();

		// settings
		let langToggle = false;
		let searchSettings = {
			shiftDown: false,
			elem: undefined,
			HISTORY_MAX_LENGTH: 5,
			showHistory: false,
			// history: []
			historyEng: [],
			historyChk: []
		};
		let soundSettings = {
			player: document.createElement('audio'),
			speakerAbbreviations: ['H',           'J'         ],
			speakerNames:         ['Holly Wyatt', 'Jane Wyatt']
		};

		// build dictionary
		let dictionary = new Dictionary(primary_eng, secondary_chk);
		dictionary.loadData( parse_en_ch_v10(tsv_en_ch_v10) );



		//// MEDIA RESOURCES ////

		// all resource interactions exclusively in lowercase to avoid problems with OS, proper nouns, bad naming
		let imageResources = {};
		let audioResources = {};

		// media indexing
		function indexResources () {
			const t0_resource_index = performance.now();
			let numResources = 0;
			// images: filename is word in english, with spaces if applicable
			for (let image of image_en_ch) {
				const word = [...image.matchAll(/(?<=\/)[^\/]+(?=\.)/g)][0][0].toLowerCase(); // use lookahead/lookbehind to isolate word in filename
				if (!word) continue;
				numResources++;
				if (!imageResources[word]) {
					imageResources[word] = [image];
				} else {
					imageResources[word].push(image);
				}
			}
			// audio: filename is word in chukchansi, an underscore, and a speaker ID
			for (let audio of audio_en_ch) {
				const word = [...audio.matchAll(/(?<=\/)[^\/]+(?=\_.+\.)/g)][0][0].toLowerCase(); // use lookahead/lookbehind to isolate word in filename
				if (!word) continue;
				numResources++;
				if (!audioResources[word]) {
					audioResources[word] = [audio];
				} else {
					audioResources[word].push(audio);
				}
			}
			console.log(numResources + ' media resources indexed in ' + (performance.now()-t0_resource_index) + 'ms. (' + image_en_ch.length + ' image, ' + audio_en_ch.length + ' audio)');
		}

		// media access
		function playSound (filename) {
			soundSettings.player.pause();
			soundSettings.player.src = 'source/' + filename;
			soundSettings.player.play();
		}
		function findIndexedImages (entry, word) {
			// rets array of image files for any synonym/form of "entry"
			// if "word" is specified, exact filename matches will be moved to the front of the array
			// needed in cases like "leeleʔhiy'", which means "book"/"school" in diff contexts that have very diff images
			if (Object.keys(imageResources).length == 0) console.warn('Attempted to access images before any were indexed.');
			let resources = [];
			word = word.toLowerCase();
			entry.forEachPrimaryForm(synonyms => {
				for (let form of synonyms) {
					form = form.toLowerCase();
					if (imageResources[form]) {
						for (const image of imageResources[form]) {
							(word && form==word) ? resources.unshift(image) : resources.push(image);
						}
					}
				}
			});
			entry.forEachSecondaryForm(synonyms => {
				for (let form of synonyms) {
					form = form.toLowerCase();
					if (imageResources[form]) {
						for (const image of imageResources[form]) {
							(word && form==word) ? resources.unshift(image) : resources.push(image);
						}
					}
				}
			});
			return resources;
		}
		function findIndexedAudio (entry, word) {
			// rets array of image files for any synonym/form of "entry"
			// if "word" is specified, exact filename matches will be moved to the front of the array
			// needed in cases like "leeleʔhiy'", which means "book"/"school" in diff contexts that have very diff images
			if (Object.keys(audioResources).length == 0) console.warn('Attempted to access audio before any was indexed.');
			let resources = [];
			word = word.toLowerCase();
			entry.forEachPrimaryForm(synonyms => {
				for (let form of synonyms) {
					form = form.toLowerCase();
					if (audioResources[form]) {
						for (const audio of audioResources[form]) {
							(word && form==word) ? resources.unshift(audio) : resources.push(audio);
						}
					}
				}
			});
			entry.forEachSecondaryForm(synonyms => {
				for (let form of synonyms) {
					form = form.toLowerCase();
					if (audioResources[form]) {
						for (const audio of audioResources[form]) {
							(word && form==word) ? resources.unshift(audio) : resources.push(audio);
						}
					}
				}
			});
			return resources;
		}



		/////////////////////////////////////////////////////////////////////

		//// CORE ////

		const subscriptFind = new RegExp('_([0-9]*)', 'ig'); // global, case-insensitive
		const subscriptReplace = '<sub>$1</sub>';
		const trySubscript = (text='') => text.replaceAll(subscriptFind, subscriptReplace);
		function capitalize (s) { s=s.toString().toLowerCase(); return (s[0]||'').toUpperCase()+s.substr(1); }


		

		// search result builders

		
		// function addSearchResultMediaIcons (entry, word) {
		// 	let audioResources = findResources(entry, audio_en_ch);
		// 	let imageResources = findResources(entry, image_en_ch);

		// 	let elemStr = '';

		// 	elemStr += trySubscript(word);
		// 	if (audioResources.length > 0) elemStr += '<div class="searchResultAudioIcon"></div>';
		// 	if (imageResources.length > 0) elemStr += '<div class="searchResultImageIcon"></div>';

		// 	const element = document.getElementById(word);
		// 	if (element) element.innerHTML = elemStr;
		// }



		//// STATIC PAGE CONSTRUCTION ////

		function populateSearchResults () {
			const t0_populate = performance.now();

			const container = document.getElementById('searchResults');

			function buildSearchResult (entry, word) {
				const chkForm0 = entry.getSecondary(0);
				const chkForm1 = entry.getSecondary(1);
				const chkForms = chkForm1 ? (chkForm0[0]+', '+chkForm1[0]) : chkForm0[0];
				const engForm0 = entry.getPrimary().join(', ');

				const catg = entry.catg;

				const audioResources = findIndexedAudio(entry,word);
				const imageResources = findIndexedImages(entry,word);

				let elemStr = '';

				elemStr += '<div id="'+word+'" class="searchResult">';
					elemStr += trySubscript(word);
					if (audioResources.length > 0) elemStr += '<div class="searchResultAudioIcon"></div>';
					if (imageResources.length > 0) elemStr += '<div class="searchResultImageIcon"></div>';
				elemStr += '</div>';

				return elemStr;
			}

			

			let elemStr = '';
			dictionary.forEachSynonym((entry, word) => { elemStr += buildSearchResult(entry, word); });
			elemStr += '<p id="noResultsText" style="display:none">No results...</p>';
			container.innerHTML = elemStr;

			console.log('DOM elements generated in ' + (performance.now()-t0_populate) + 'ms.');
		}



		//// DYNAMIC PAGE UPDATES ////

		//

		

		/////////////////////////////////////////////////////////////////////

		//// INIT ////

		function init () {
			// dummy elems pre-loaded
				// navbar
				// searchbar (empty)
				// searchResultsPanel (dummy entries, loading animation)
			// precomputation
			indexResources();
			// build DOM
			populateSearchResults();
		}
		init();

		const searchPanel = document.getElementById('searchPanel');
		// const contentPanel = document.getElementById('contentPanel');

		// // load words
		// populateSearchResults(searchPanel);
		// // load media
		// const t0_media = performance.now();
		// dictionary.forEachSynonym((entry, word) => { addSearchResultMediaIcons(entry, word); });
		// console.log('Media resources indexed in ' + (performance.now()-t0_media) + 'ms.');

		let isShowingSearch = true;
		function doSlide () {
			if (isShowingSearch) {
				for (const panel of [document.getElementById('searchPanel'),document.getElementById('searchBox'),document.getElementById('contentPanel')]) {
					panel.style.transform = 'translate(-100%,0%)';
					panel.style.animation = 'slideLeft 0.5s';
				}
			} else {
				for (const panel of [document.getElementById('searchPanel'),document.getElementById('searchBox'),document.getElementById('contentPanel')]) {
					panel.style.transform = 'translate(0%,0%)';
					panel.style.animation = 'slideRight 0.5s';
				}
			}
			isShowingSearch = !isShowingSearch;
		}

		window.addEventListener('keydown', e => {
			switch (e.key) {
			case '`':
				// doSlide();

				// indexResources();
				// console.log( "family", findIndexedImages(dictionary.searchWord("family"),"family") );
				// console.log( "family", findIndexedAudio(dictionary.searchWord("family"),"family") );
				// dictionary.togglePrimary();
				// console.log( "heedin'", findIndexedImages(dictionary.searchWord("heedin'"),"heedin'") );
				// console.log( "heedin'", findIndexedAudio(dictionary.searchWord("heedin'"),"heedin'") );
				
				populateSearchResults();
				break;
			}
		})

		// init(dictionary);
		console.log('Load time: ' + (performance.now() - t0).toFixed(0) + ' ms');

		/////////////////////////////////////////////////////////////////////
	</script>

</body>

</html>